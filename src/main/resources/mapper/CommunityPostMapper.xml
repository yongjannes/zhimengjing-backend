<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sf.zhimengjing.mapper.admin.CommunityPostMapper">

    <resultMap id="CommunityPostListVOMap" type="com.sf.zhimengjing.common.model.vo.CommunityPostListVO">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="userAvatar" column="user_avatar"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="contentText" column="content_text"/>
        <result property="images" column="images"/>
        <result property="tags" column="tags"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="shareCount" column="share_count"/>
        <result property="collectCount" column="collect_count"/>
        <result property="isTop" column="is_top"/>
        <result property="isHot" column="is_hot"/>
        <result property="isAnonymous" column="is_anonymous"/>
        <result property="status" column="status"/>
        <result property="statusText" column="status_text"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="adminRemark" column="admin_remark"/>
        <result property="publishedAt" column="published_at"/>
        <result property="lastCommentedAt" column="last_commented_at"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="selectPostListPage" resultMap="CommunityPostListVOMap">
        SELECT
        cp.id,
        cp.user_id,
        u.username AS user_name,
        u.nickname AS user_nickname,
        u.avatar AS user_avatar,
        cp.title,
        cp.content,
        cp.content_text,
        cp.images,
        cp.tags,
        cp.category_id,
        dc.name AS category_name,
        cp.view_count,
        cp.like_count,
        cp.comment_count,
        cp.share_count,
        cp.collect_count,
        cp.is_top,
        cp.is_hot,
        cp.is_anonymous,
        cp.status,
        CASE cp.status
        WHEN 0 THEN '待审核'
        WHEN 1 THEN '已通过'
        WHEN 2 THEN '已拒绝'
        WHEN 3 THEN '已删除'
        ELSE '未知'
        END AS status_text,
        cp.reject_reason,
        cp.admin_remark,
        cp.published_at,
        cp.last_commented_at,
        cp.create_time,
        cp.update_time
        FROM community_posts cp
        LEFT JOIN users u ON cp.user_id = u.id
        LEFT JOIN dream_categories dc ON cp.category_id = dc.id
        WHERE cp.deleted = 0
        <if test="query.userName != null and query.userName != ''">
            AND u.username LIKE CONCAT('%', #{query.userName}, '%')
        </if>
        <if test="query.title != null and query.title != ''">
            AND cp.title LIKE CONCAT('%', #{query.title}, '%')
        </if>
        <if test="query.content != null and query.content != ''">
            AND cp.content_text LIKE CONCAT('%', #{query.content}, '%')
        </if>
        <if test="query.status != null">
            AND cp.status = #{query.status}
        </if>
        <if test="query.isTop != null">
            AND cp.is_top = #{query.isTop}
        </if>
        <if test="query.isHot != null">
            AND cp.is_hot = #{query.isHot}
        </if>
        <if test="query.categoryId != null">
            AND cp.category_id = #{query.categoryId}
        </if>
        <if test="query.createTimeStart != null">
            AND cp.create_time &gt;= #{query.createTimeStart}
        </if>
        <if test="query.createTimeEnd != null">
            AND cp.create_time &lt;= #{query.createTimeEnd}
        </if>
        ORDER BY cp.is_top DESC, cp.create_time DESC
    </select>

    <select id="selectPostStatistics" resultType="com.sf.zhimengjing.common.model.vo.CommunityPostStatisticsVO">
        SELECT
            COUNT(*) AS totalPosts,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS pendingPosts,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS approvedPosts,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS rejectedPosts,
            SUM(CASE WHEN DATE(create_time) = CURDATE() THEN 1 ELSE 0 END) AS todayNewPosts,
            SUM(CASE WHEN YEARWEEK(create_time, 1) = YEARWEEK(NOW(), 1) THEN 1 ELSE 0 END) AS weekNewPosts
        FROM community_posts
        WHERE deleted = 0
    </select>

</mapper>